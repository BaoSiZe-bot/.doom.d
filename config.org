#+TITLE: Abalonemacs
#+author: baosize-bot
#+PROPERTY: header-args

* 概述
#+begin_quote
“I'm rarely happier than when spending an entire day programming my computer to perform automatically a task that would otherwise take me a good ten seconds to do by hand.” - Douglas Adams
#+end_quote

我用 [[https://github.com/doomemacs/doomemacs/][Doom Emacs]]（以下简称Doom）作为 Emacs 基本配置。这是一个literate配置文件, 指定了Doom的所有配置并包含了文档。如果将这个文件导入到 =~/.doom.d/config.org= ，Doom 会在启动或此文件变动时时自动 tangle 此文件中的代码到对应的文件中。

如果你在浏览器中打开这个文件，你可以考虑在 Emacs Org mode 中打开它以获得更好的阅读体验 :).

在更改各种package.el和init.el后，请记得运行 =doom sync= 。

这个配置仍在不断优化中，目前启动速度极慢，达 0.7s （在 WSL 中测试）。
** 灵感
- [[https://github.com/cnsunyour/.doom.d][cnsunyour's Doom Emacs]] 本配置中中文输入法部分借鉴了此处的写法。
- [[https://github.com/manateelazycat/lazycat-emacs][Lazycat Emacs]] 本配置中半数插件取材于此。
- [[https://github.com/h0cheung/doom-emacs-config][H-cheung's Doom Emacs]] 本配置基于此修改而来。

* 目录 :QUOTE:TOC_3:
#+BEGIN_QUOTE
- [[#概述][概述]]
  - [[#灵感][灵感]]
- [[#initel][init.el]]
- [[#configel][config.el]]
- [[#packagesel][packages.el]]
- [[#个人模块][个人模块]]
  - [[#meow][meow]]
  - [[#baosize][baosize]]
    - [[#awesome-tray][awesome-tray]]
    - [[#blink-search][blink-search]]
    - [[#color-rg][color-rg]]
    - [[#eaf][EAF]]
    - [[#holo-layer][holo-layer]]
    - [[#sort-tab][sort-tab]]
    - [[#chinese][chinese]]
    - [[#lsp][lsp]]
    - [[#corfu][corfu]]
    - [[#tools][tools]]
    - [[#treesit-context][treesit-context]]
    - [[#vterm-run][vterm-run]]
#+END_QUOTE

* init.el
本部分决定了Doom所启用的模块和加载顺序。
#+begin_src emacs-lisp :tangle init.el
;;; init.el -*- lexical-binding: t; -*-

;; This file controls what Doom modules are enabled and what order they load
;; in. Remember to run 'doom sync' after modifying it!

;; NOTE Press 'SPC h d h' (or 'C-h d h' for non-vim users) to access Doom's
;;      documentation. There you'll find a link to Doom's Module Index where all
;;      of our modules are listed, including what flags they support.

;; NOTE Move your cursor over a module's name (or its flags) and press 'K' (or
;;      'C-c c k' for non-vim users) to view its documentation. This works on
;;      flags as well (those symbols that start with a plus).
;;
;;      Alternatively, press 'gd' (or 'C-c c d') on a module to browse its
;;      directory (for easy access to its source code).

(doom! :input
       ;;bidi              ; (tfel ot) thgir etirw uoy gnipleh
       ;;chinese
       ;;japanese
       ;;layout            ; auie,ctsrnm is the superior home row

       :completion
       ;;(company +childframe)          ; the ultimate code completion backend
       ;;(corfu +icons)    ; complete with cap(f), cape and a flying feather!
       ;;helm              ; the *other* search engine for love and life
       ;;ido               ; the other *other* search engine...
       ;;ivy               ; a search engine for love and life
       (vertico +icons)    ; the search engine of the future

       :ui
       ;;deft              ; notational velocity for Emacs
       doom                ; what makes DOOM look the way it does
       doom-dashboard      ; a nifty splash screen for Emacs
       ;;doom-quit         ; DOOM quit-message prompts when you quit Emacs
       ;;(emoji +unicode)  ; 🙂
       hl-todo             ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
       ;;indent-guides     ; highlighted indent columns
       ligatures           ; ligatures and symbols to make your code pretty again
       ;;minimap           ; show a map of the code on the side
       modeline            ; snazzy, Atom-inspired modeline, plus API
       nav-flash           ; blink cursor line after big motions
       ;;neotree           ; a project drawer, like NERDTree for vim
       ;;ophints           ; highlight the region an operation acts on
       (popup +defaults)   ; tame sudden yet inevitable temporary windows
       ;;tabs              ; a tab bar for Emacs
       ;;treemacs          ; a project drawer, like neotree but cooler
       unicode             ; extended unicode support for various languages
       (vc-gutter +pretty) ; vcs diff in the fringe
       ;;vi-tilde-fringe   ; fringe tildes to mark beyond EOB
       ;;window-select     ; visually switch windows
       workspaces          ; tab emulation, persistence & separate workspaces
       zen                 ; distraction-free coding or writing

       :editor
       meow                ; come to the dark side, we have cookies
       ;;file-templates    ; auto-snippets for empty files
       fold                ; (nigh) universal code folding
       (format +onsave)    ; automated prettiness
       ;;god               ; run Emacs commands without modifier keys
       ;;lispy             ; vim for lisp, for people who don't like vim
       multiple-cursors    ; editing in many places at once
       ;;objed             ; text object editing for the innocent
       ;;parinfer          ; turn lisp into python, sort of
       ;;rotate-text       ; cycle region at point between text candidates
       snippets            ; my elves. They type so I don't have to
       ;;word-wrap         ; soft wrapping with language-aware indent

       :emacs
       ;;dired             ; making dired pretty [functional]
       ;;electric          ; smarter, keyword-based electric-indent
       ;;eww               ; the internet is gross
       ;;ibuffer           ; interactive buffer management
       ;;undo              ; persistent, smarter undo for your inevitable mistakes
       ;;vc                ; version-control and Emacs, sitting in a tree

       :term
       ;;eshell            ; the elisp shell that works everywhere
       ;;shell             ; simple shell REPL for Emacs
       ;;term              ; basic terminal emulator for Emacs
       vterm               ; the best terminal emulation in Emacs

       :checkers
       (syntax +childframe +flymake)             ; tasing you for every semicolon you forget
       ;;(spell +flyspell) ; tasing you for misspelling mispelling
       ;;grammar           ; tasing grammar mistake every you make

       :tools
       ;;ansible
       ;;biblio            ; Writes a PhD for you (citation needed)
       ;;collab            ; buffers with friends
       debugger            ; FIXME stepping through code, to help you add bugs
       ;;direnv
       ;;docker
       editorconfig        ; let someone else argue about tabs vs spaces
       ;;ein               ; tame Jupyter notebooks with emacs
       eval                ; run code, run (also, repls)
       lookup              ; navigate your code and its documentation
       ;; (lsp +eglot)     ; M-x vscode
       magit               ; a git porcelain for Emacs
       ;;make              ; run make tasks from Emacs
       ;;pass              ; password manager for nerds
       ;;pdf               ; pdf enhancements
       ;;prodigy           ; FIXME managing external services & code builders
       ;;terraform         ; infrastructure as code
       ;;tmux              ; an API for interacting with tmux
       ;;tree-sitter       ; syntax and parsing, sitting in a tree...
       ;;upload            ; map local to remote projects via ssh/ftp

       :os
       (:if (featurep :system 'macos) macos)  ; improve compatibility with macOS
       (tty +osc)          ; improve the terminal Emacs experience

       :lang
       ;;agda              ; types of types of types of types...
       ;;beancount         ; mind the GAAP
       ;;(cc +lsp)         ; C > C++ == 1
       ;;clojure           ; java with a lisp
       ;;common-lisp       ; if you've seen one lisp, you've seen them all
       ;;coq               ; proofs-as-programs
       ;;crystal           ; ruby at the speed of c
       ;;csharp            ; unity, .NET, and mono shenanigans
       ;;data              ; config/data formats
       ;;(dart +flutter)   ; paint ui and not much else
       ;;dhall
       ;;elixir            ; erlang done right
       ;;elm               ; care for a cup of TEA?
       emacs-lisp          ; drown in parentheses
       ;;erlang            ; an elegant language for a more civilized age
       ;;ess               ; emacs speaks statistics
       ;;factor
       ;;faust             ; dsp, but you get to keep your soul
       ;;fortran           ; in FORTRAN, GOD is REAL (unless declared INTEGER)
       ;;fsharp            ; ML stands for Microsoft's Language
       ;;fstar             ; (dependent) types and (monadic) effects and Z3
       ;;gdscript          ; the language you waited for
       ;;(go +lsp)         ; the hipster dialect
       ;;(graphql +lsp)    ; Give queries a REST
       ;;(haskell +lsp)    ; a language that's lazier than I am
       ;;hy                ; readability of scheme w/ speed of python
       ;;idris             ; a language you can depend on
       ;;json              ; At least it ain't XML
       ;;(java +lsp)       ; the poster child for carpal tunnel syndrome
       ;;javascript        ; all(hope(abandon(ye(who(enter(here))))))
       ;;julia             ; a better, faster MATLAB
       ;;kotlin            ; a better, slicker Java(Script)
       ;;latex             ; writing papers in Emacs has never been so fun
       ;;lean              ; for folks with too much to prove
       ;;ledger            ; be audit you can be
       ;;lua               ; one-based indices? one-based indices
       markdown            ; writing docs for people to ignore
       ;;nim               ; python + lisp at the speed of c
       ;;nix               ; I hereby declare "nix geht mehr!"
       ;;ocaml             ; an objective camel
       (org +pretty)       ; organize your plain life in plain text
       ;;php               ; perl's insecure younger brother
       ;;plantuml          ; diagrams for confusing people more
       ;;graphviz          ; diagrams for confusing yourself even more
       ;;purescript        ; javascript, but functional
       ;;python            ; beautiful is better than ugly
       ;;qt                ; the 'cutest' gui framework ever
       ;;racket            ; a DSL for DSLs
       ;;raku              ; the artist formerly known as perl6
       ;;rest              ; Emacs as a REST client
       ;;rst               ; ReST in peace
       ;;(ruby +rails)     ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
       ;;(rust +lsp)       ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
       ;;scala             ; java, but good
       ;;(scheme +guile)   ; a fully conniving family of lisps
       ;;sh                ; she sells {ba,z,fi}sh shells on the C xor
       ;;sml
       ;;solidity          ; do you need a blockchain? No.
       ;;swift             ; who asked for emoji variables?
       ;;terra             ; Earth and Moon in alignment for performance.
       ;;web               ; the tubes
       ;;yaml              ; JSON, but readable
       ;;zig               ; C, but simpler

       :app
       ;;calendar
       ;;emms
       ;;everywhere        ; *leave* Emacs!? You must be joking
       ;;irc               ; how neckbeards socialize
       ;;(rss +org)        ; emacs as an RSS reader

       :email
       ;;(mu4e +org +gmail)
       ;;notmuch
       ;;(wanderlust +gmail)

       :config
       literate
       ;;use-package
       (default +bindings)

       :baosize
       chinese
       tools
       ;;awesome-tray
       ;;holo-layer
       eaf
       blink-search
       (mycorfu +icons)    ; complete with cap(f), cape and a flying feather!
       sort-tab
       color-rg
       (lsp +eglot)        ; M-x vscode
       treesit-context
       vterm-run)
#+end_src
* config.el
:PROPERTIES:
:header-args: :tangle config.el
:END:
#+begin_src emacs-lisp
;;; config.el -*- lexical-binding: t; -*-
#+end_src
85%真透明（只透明背景，不透明文字）
#+begin_src emacs-lisp
(add-to-list 'default-frame-alist '(alpha-background . 85))
#+end_src
moonlight 主题
#+begin_src emacs-lisp
(setq doom-theme 'doom-moonlight)
#+end_src
VictorMono & 霞鹜文楷，emoji设置特殊字体
#+begin_src emacs-lisp
(setq doom-font (font-spec :family "VictorMono Nerd Font" :size 17 :weight 'Regular)
      doom-symbol-font (font-spec :family "霞鹜文楷" :size 17 :weight 'Regular)
      doom-variable-pitch-font (font-spec :family "霞鹜文楷" :size 17 :weight 'Regular)
      doom-big-font (font-spec :family "VictorMono Nerd Font" :size 20 :weight 'Regular)
      nerd-icons-font-family "VictorMono Nerd Font")
(set-fontset-font t 'han (font-spec :family "霞鹜文楷" :size 19 :weight 'Regular))
(defun +font-set-emoji (&rest _)
  (set-fontset-font t 'emoji "Noto Color Emoji" nil 'prepend))
(add-hook 'after-setting-font-hook #'+font-set-emoji)
#+end_src
Treesitter 默认的高亮太素了，但是定义多了影响速度，设置一下jit-lock-defer-time
#+begin_src emacs-lisp
(setq treesit-font-lock-level 4
      major-mode-remap-alist
      '((yaml-mode . yaml-ts-mode)
        (sh-mode . bash-ts-mode)
        (js-mode . js-ts-mode)
        (css-mode . css-ts-mode)
        (c-mode . c-ts-mode)
        (c++-mode . c++-ts-mode)
        (c-or-c++-mode . c-or-c++-ts-mode)
        (python-mode . python-ts-mode)))
(defun my-fontify-variable (node override start end &rest _)
  (let ((parent (treesit-node-parent node)) tyn)
    (catch 'break
      (while parent
        (setq tyn (treesit-node-type parent))
        (cond ((or (equal tyn "call_expression") (equal tyn "template_function"))
               (progn
                 (treesit-fontify-with-override (treesit-node-start node) (treesit-node-end node) 'font-lock-function-call-face override start end)
                 (throw 'break nil))))
        (cond ((or (equal tyn "argument_list") (equal tyn "field_expression")) (progn (setq parent nil) (throw 'break nil))))
        (cond (t (setq parent (treesit-node-parent parent))))))
    (when (not parent) (treesit-fontify-with-override (treesit-node-start node) (treesit-node-end node) 'font-lock-variable-use-face override start end))))
(advice-add 'c-ts-mode--fontify-variable :around (lambda (fn &rest args) (eval `(my-fontify-variable ,@args))))
(defun my-c-font-lock-settings (fn mode)
  (if (eq mode 'cpp)
      `(
        ,@(treesit-font-lock-rules
           :language 'cpp
           :feature 'function
           '((destructor_name (identifier) @font-lock-function-name-face))
           :language mode
           :feature 'property
           '((template_method (field_identifier) @font-lock-function-call-face)))
        ,@(funcall fn mode))
    (funcall fn mode)))
(advice-add 'c-ts-mode--font-lock-settings :around 'my-c-font-lock-settings)
(add-hook 'meow-insert-mode-hook (lambda () (setq jit-lock-defer-time 0.25)))
(add-hook 'meow-normal-mode-hook (lambda () (setq jit-lock-defer-time 0)))
#+end_src
C++ 缩进和调试
#+begin_src emacs-lisp
(add-hook 'c++-ts-mode-hook (lambda ()
(setq c-basic-offset 4)
(rainbow-delimiters-mode-enable)
(treesit-context)
(bind-key "C-c d c" #'cpp-gdb 'c++-ts-mode-map)
 (defun cpp-gdb ()
   (interactive)
   (if buffer-file-name
       (let ((filename (file-name-sans-extension (file-name-nondirectory buffer-file-name))))
         (when (eq 0 (shell-command (concat "g++ -g3 -std=c++17 " buffer-file-name " -o /tmp/cpp-" filename)))
           (gdb (concat "gdb -i=mi /tmp/cpp-" filename))))
     (message "buffer-file-name is nil")))))
#+end_src
Org-mode 相关
#+begin_src emacs-lisp
(bind-keys ("C-c f o" . consult-org-agenda))
(remove-hook 'org-mode-hook #'+literate-enable-recompile-h)
#+end_src
由于本人使用fish作为默认shell所以要做一点操作才行
#+begin_src emacs-lisp
(setq shell-file-name (executable-find "bash"))
(setq-default vterm-shell (executable-find "fish"))
(setq-default explicit-shell-file-name (executable-find "fish"))
#+end_src
悬浮窗口
corfu 貌似不应该出现在这里，但是不放这里就没法工作
#+begin_src emacs-lisp 
(standard-display-unicode-special-glyphs) ; 终端中的弹窗不设置会使用ASCII边框
(with-eval-after-load 'corfu
  (global-corfu-mode)
  (add-hook 'corfu-mode-hook #'corfu-popupinfo-mode))
#+end_src
别再提醒我 "Really kill emacs?" 了。
从 manateelazycat 大佬的配置上抄的，但我并不知道新语法 advice-add 怎么用。
#+begin_src emacs-lisp
;; (advice-add 'save-buffer-kill-emacs :around (lambda (fn &rest)
;;   (require 'noflet)
;;   (setq confirm-kill-emacs nil)
;;   (noflet (process-list) ad-do-it)))
(defadvice save-buffers-kill-emacs (around no-query-kill-emacs activate)
  "Prevent annoying \"Active processes exist\" query when you quit Emacs."
  (require 'noflet)
  (setq confirm-kill-emacs nil)
  (noflet (process-list) ad-do-it))
#+end_src
自定义Variables和Faces

我不知道这是干嘛用的，但它既然在这里……
#+begin_src emacs-lisp
(custom-set-variables)
;; custom-set-variables was added by Custom.
;; If you edit it by hand, you could mess it up, so be careful.
;; Your init file should contain only one such instance.
;; If there is more than one, they won't work right.
(custom-set-faces)
;; custom-set-faces was added by Custom.
;; If you edit it by hand, you could mess it up, so be careful.
;; Your init file should contain only one such instance.
;; If there is more than one, they won't work right.
#+end_src
* packages.el
Emacs 核心所需的插件
#+begin_src emacs-lisp :tangle packages.el
;; -*- no-byte-compile: t; -*-
;;; packages.el
(unpin! t)
;;(package! vc-msg)
;;(package! power-mode)
;;(package! imenu-list)
(package! noflet)
(package! cal-china-x)
;;(package! railgun :recipe(:host github :repo "gynamics/railgun.el"))
#+end_src
* 个人模块
** meow
Evil实在是太重了，但我又无法适应Emacs原生按键，就使用轻量级的Meow了

=M-x meow-tutor= 以学习Meow按键（类似于vim-tutor）
#+begin_src emacs-lisp :tangle modules/editor/meow/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/editor/meow/packages.el

(package! meow)
#+end_src
#+begin_src emacs-lisp :tangle modules/editor/meow/config.el
;;; modules/editor/meow/config.el -*- lexical-binding: t; -*-
(defun meow/setup ()
  (setq meow-use-cursor-position-hack t
        meow-use-clipboard t
        meow-use-enhanced-selection-effect t)
  (bind-keys :map meow-normal-state-keymap
             ("0" . meow-expand-0)
             ("1" . meow-expand-1)
             ("2" . meow-expand-2)
             ("3" . meow-expand-3)
             ("4" . meow-expand-4)
             ("5" . meow-expand-5)
             ("6" . meow-expand-6)
             ("7" . meow-expand-7)
             ("8" . meow-expand-8)
             ("9" . meow-expand-9)
             ("-" . negative-argument)
             (";" . meow-reverse)
             ("," . meow-inner-of-thing)
             ("." . meow-bounds-of-thing)
             ("'" . repeat)))
(defun meow-append-this-line ()
  (interactive)
  (move-end-of-line 1)
  (meow-insert))
(defun meow-insert-this-line ()
  (interactive)
  (move-beginning-of-line 1)
  (meow-insert))
(defun meow/setup-qwerty ()
  (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)
  (meow/setup)
  (bind-keys :map meow-normal-state-keymap
   ("[" . meow-beginning-of-thing)
   ("]" . meow-end-of-thing)
   ("a" . meow-append)
   ("o" . meow-open-below)
   ("A" . meow-append-this-line)
   ("b" . meow-back-word)
   ("B" . meow-back-symbol)
   ("c" . meow-change)
   ("e" . meow-next-word)
   ("E" . meow-next-symbol)
   ("f" . meow-find)
   ("g" . meow-cancel-selection)
   ("G" . meow-grab)
   ("h" . meow-left)
   ("H" . meow-left-expand)
   ("i" . meow-insert)
   ("I" . meow-insert-this-line)
   ("O" . meow-open-above)
   ("j" . meow-next)
   ("J" . meow-next-expand)
   ("k" . meow-prev)
   ("K" . meow-prev-expand)
   ("l" . meow-right)
   ("L" . meow-right-expand)
   ("v" . meow-visit)
   ("m" . meow-join)
   ("n" . meow-search)
   ("%" . meow-block)
   ("p" . meow-yank)
   ("q" . meow-quit)
   ("Q" . meow-goto-line)
   ("r" . meow-replace)
   ("R" . meow-swap-grab)
   ("d" . meow-kill)
   ("t" . meow-till)
   ("u" . meow-undo)
   ("U" . meow-undo-in-selection)
   ("/" . meow-comment)
   ("w" . meow-mark-word)
   ("W" . meow-mark-symbol)
   ("x" . meow-line)
   ("X" . meow-goto-line)
   ("y" . meow-save)
   ("Y" . meow-sync-grab)
   ("z" . meow-pop-selection)))

(use-package meow
  :hook (doom-after-modules-config . meow-global-mode)
  :demand t
  :config
  (meow/setup-qwerty)
  (bind-keys :map meow-keymap ([remap describe-key] . helpful-key))
  (meow-define-keys
   'normal
   '("s" . avy-goto-char)
   '("F" . avy-goto-char-2)))
#+end_src
** baosize
*** awesome-tray
懒猫的底部状态栏，代替 =modeline= ，与 =sort-tab= 一样以最小窗口空间占用为理念。
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/awesome-tray/config.el
:END:
给默认模块加图标。
#+begin_src emacs-lisp
;;; modules/baosize/awesome-tray/config.el -*- lexical-binding: t; -*-
#+end_src
显示 =lsp-bridge= 状态和诊断数目
#+begin_src emacs-lisp
(defun awesome-tray-lsp-module () (if (not (equal lsp-bridge-mode nil))
  (if (not (equal lsp-bridge-diagnostic-count nil))
      (concat " " (int-to-string lsp-bridge-diagnostic-count))
      " ")
  ""))
(defface awesome-tray-module-lsp-face
  '((((background light)) :inherit awesome-tray-orange-face)
    (t :inherit awesome-tray-orange-face))
  "Lsp-bridge face."
  :group 'awesome-tray)
#+end_src
显示当前光标所在函数
#+begin_src emacs-lisp
(defun awesome-tray-mybelong-module ()
    (let ((origin (if (modulep 'treesit)
      (let ((current-seconds (awesome-tray-current-seconds)))
        (if (or (not (eq (current-buffer) awesome-tray-belong-last-buffer))
                (> (- current-seconds awesome-tray-belong-last-time) awesome-tray-belong-update-duration))
            (progn
              (setq awesome-tray-belong-last-time current-seconds)
              (setq awesome-tray-belong-last-buffer (current-buffer))
              (awesome-tray-update-belong-cache))
          awesome-tray-belong-cache))"")))
        (if (equal origin "") "" (concat "󰡱 " origin))))
#+end_src
显示 =meow= 状态
#+begin_src emacs-lisp
(defun awesome-tray-mymeow-module ()
  (let ((origin (with-demoted-errors
      ""
    (if (and (modulep 'meow) awesome-tray-meow-show-mode)
        meow--indicator
      ""))))
    (concat "󰄛" origin)))
#+end_src
显示 =Git= 状态
#+begin_src emacs-lisp
(defun awesome-tray-mygit-module ()
  (let ((origin (if (executable-find "git")
      (progn
        (if (not (string= (buffer-file-name) awesome-tray-git-buffer-filename))
            (awesome-tray-git-command-update-cache))
        awesome-tray-git-command-cache)
    "")))
    (if (equal origin "") "" (concat " " origin))))
#+end_src
添加上述模块到 =awesome-tray= 核心并挂上启动时的钩子
#+begin_src emacs-lisp
(use-package 'awesome-tray
:defer t
:hook (doom-after-init . awesome-tray-mode)
:custom
(awesome-tray-buffer-read-only-style "󰌾 ")
(awesome-tray-mode-line-active-color "#4ea9e6")
(awesome-tray-belong-update-duration 1)
(awesome-tray-active-modules '("winum"
                               "lsp"
                               "input-method"
                               "mybelong"
                               "mymeow"
                               "file-path"
                               "buffer-read-only"
                               "mygit"
                               "󰥔"
                               "date"
                               "clock"))
(awesome-tray-input-method-local-style "㞢")
:config
(add-to-list 'awesome-tray-module-alist
       '("winum" . (awesome-tray-winum-module awesome-tray-winum-module-face)))
(add-to-list 'awesome-tray-module-alist
       '("mybelong" . (awesome-tray-mybelong-module awesome-tray-module-belong-face)))
(add-to-list 'awesome-tray-module-alist
       '("mymeow" . (awesome-tray-mymeow-module awesome-tray-module-meow-face)))
(add-to-list 'awesome-tray-module-alist
       '("mygit" . (awesome-tray-mygit-module awesome-tray-module-git-face)))
(add-to-list 'awesome-tray-module-alist
       '("lsp" . (awesome-tray-lsp-module awesome-tray-module-lsp-face))))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/awesome-tray/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/awesome-tray/packages.el
(package! awesome-tray
  :recipe (:host github :repo "manateelazycat/awesome-tray"))
#+end_src
*** blink-search
懒猫的多源搜索，据说很快就可以取代 =vertico+consult= 全家桶了。
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/blink-search/config.el
:END:
声明
#+begin_src emacs-lisp
;;; modules/baosize/blink-search/config.el -*- lexical-binding: t; -*-
(use-package blink-search
#+end_src
由于某种原因， =blink-search= 不能正常加载，需要指定 =load-path= 。

注意如果把 Doom 安装在 =~/.config/emacs= 需要更改位置。
#+begin_src emacs-lisp
:load-path "~/.emacs.d/.local/straight/repos/blink-search/"
#+end_src
绑定键位就使用默认的 =C-M-g= 吧。
#+begin_src emacs-lisp
:bind (("C-M-g" . blink-search))
#+end_src
进入 =blink-search= 时肯定得是 =meow-insert-mode= 啊
#+begin_src emacs-lisp
:config (add-hook 'blink-search-mode-hook #'meow-insert))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/blink-search/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/blink-search/packages.el
(package! blink-search
  :recipe (:host github :repo "manateelazycat/blink-search"))
#+end_src
*** color-rg
懒猫的搜索插件，类似于 =el-search= ，但是更易用，更快
**** config.el
#+begin_src emacs-lisp :tangle modules/baosize/color-rg/config.el
;;; modules/baosize/color-rg/config.el -*- lexical-binding: t; -*-
(use-package color-rg
  :bind
  (("C-c r i" . color-rg-search-input)
   ("C-c r s" . color-rg-search-symbol)
   ("C-c r I" . color-rg-search-input-in-project)
   ("C-c r S" . color-rg-search-symbol-in-project)
   ("C-c r b" . color-rg-search-input-in-current-file)
   ("C-c r j" . color-rg-search-symbol-in-current-file)
   ("C-c r t" . color-rg-search-project-with-type)
   ("C-c r x" . color-rg-search-symbol-with-type)))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/color-rg/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/color-rg/packages.el
(package! color-rg
  :recipe (:host github :repo "manateelazycat/color-rg"))
#+end_src
*** EAF
=Emacs Application Frames= ，由懒猫开发的使 "Live in Emacs" 成为现实的超级应用框架，也是本配置的核心之一。
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/eaf/config.el
:END:
#+begin_src emacs-lisp
;;; modules/baosize/eaf/config.el -*- lexical-binding: t; -*-
#+end_src
判断是否是终端，是则不加载 EAF 以节省启动时间
#+begin_src emacs-lisp
(when (and (display-graphic-p) (not (daemonp)))
#+end_src
启动 EAF 框架
#+begin_src emacs-lisp
(use-package eaf
  :after-call doom-after-init-hook
  :hook
  (eaf-mode . doom-modeline-mode)
  :init
  (bind-keys ("C-c ee" . eaf-open-this-buffer)
             ("C-c ef" . eaf-open)
             ("C-c em" . eaf-open-bookmark)))
#+end_src
启动浏览器（这么大一个包，肯定得懒加载）
#+begin_src emacs-lisp
(use-package eaf-browser
#+end_src
自定义外观
#+begin_src emacs-lisp
  :custom
  ;;eaf-browser-dark-mode t
  (eaf-browser-default-search-engine "bing")
  (eaf-webengine-font-family "VictorMono Nerd Font")
  (eaf-webengine-fixed-font-family "VictorMono Nerd Font")
  (eaf-webengine-serif-font-family "VictorMono Nerd Font")
  (eaf-webengine-font-size 16)
  (eaf-webengine-fixed-font-size 16)
#+end_src
自定义搜索引擎
#+begin_src emacs-lisp
  (eaf-browser-search-engines '(("bing" . "https://bing.com/search?q=%s"))
                               ("baidu" . "https://www.baidu.com/search?ie=utf-8&q=%s")
                               ("google" . "http://www.google.com/search?ie=utf-8&q=%s")
                               ("duckduckgo" . "https://duckduckgo.com/?q=%s"))
#+end_src
ESC 退出焦点
#+begin_src emacs-lisp
  :config
  (eaf-bind-key clear_focus "<escape>" eaf-browser-keybinding)
#+end_src
洛谷小插件😅
#+begin_src emacs-lisp
  (defun luogu-open-problem (pid)
    (interactive "M[Luogu] ProblemID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/problem/" pid)))
  (defun luogu-open-discuss (did)
    (interactive "M[Luogu] DiscussID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/discuss/" did)))
  (defun luogu-open-training (tid)
    (interactive "M[Luogu] TrainingID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/training/" tid)))
  (defun luogu-open-user-home (uid)
    (interactive "M[Luogu] UserID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/user/" uid)))
  (defun luogu-open-contest (cid)
    (interactive "M[Luogu] ContestID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/contest/" cid)))
  (defun luogu-open-team (teamid)
    (interactive "M[Luogu] TeamID: ")
    (require 'eaf-browser)
    (eaf-open-browser (concat "https://www.luogu.com.cn/team/" teamid)))
#+end_src
浏览器键绑定
#+begin_src emacs-lisp
  :bind (("C-c e b" . eaf-open-browser)
         ("C-c e h" . eaf-open-browser-with-history)
         ("C-c e B" . eaf-open-browser-other-window)
         ("C-c e s" . eaf-open-browser-same-window)
         ("C-c elc" . luogu-open-contest)
         ("C-c eld" . luogu-open-discuss)
         ("C-c ele" . luogu-open-team)
         ("C-c elp" . luogu-open-problem)
         ("C-c elt" . luogu-open-training)
         ("C-c elu" . luogu-open-user-home)))
#+end_src
启动终端
#+begin_src emacs-lisp
(use-package eaf-pyqterminal
#+end_src
设置外观
#+begin_src emacs-lisp
  :custom
  (eaf-pyqterminal-font-size 16)
  (eaf-pyqterminal-font-family "VictorMono Nerd Font")
#+end_src
终端键绑定
#+begin_src emacs-lisp
  :bind (("C-c e t" . eaf-open-pyqterminal)
         ("C-c e i" . eaf-open-ipython)))
#+end_src
文件管理器键绑定
#+begin_src emacs-lisp
(use-package eaf-file-manager
 :bind (("C-c e /" . eaf-open-in-file-manager)))
#+end_src
目前存在没修好的 bug 的一些包
#+begin_src emacs-lisp
;; (setq eaf-pdf-dark-mode t)
;; (use-package eaf-git :bind (("C-c e g" . eaf-open-git)))
;; (add-hook org-mode (lambda () (progn (setq eaf-org-dark-mode t) (require 'eaf)(require 'eaf-org-previewer))))
;; (add-hook markdown-mode (lambda ()(progn (setq eaf-markdown-dark-mode t) (require 'eaf)(require 'eaf-markdown-previewer))))
)
#+end_src
**** packages.el
:PROPERTIES:
:header-args: :tangle modules/baosize/eaf/packages.el
:END:
#+begin_src emacs-lisp
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/eaf/packages.el
#+end_src
eaf 需要编译相关依赖
#+begin_src emacs-lisp
(defun +eaf-install-deps-for-app(app-dir)
  "Install deps from dependencies.json."
  (let* ((deps-dict (with-temp-buffer
                      (insert-file-contents
                       (expand-file-name "dependencies.json" app-dir))
                      (json-parse-string (buffer-string))))
         (pip-deps (gethash (if IS-LINUX "linux" "darwin")
                            (or (gethash "pip" deps-dict)
                                (make-hash-table))))
         (vue-install (gethash "vue_install" deps-dict))
         (npm-install (gethash "npm_install" deps-dict))
         (npm-rebuild (gethash "npm_rebuild" deps-dict)))
    (when pip-deps
      (dolist (pkg (append pip-deps nil))
        (message "%s" (shell-command-to-string (format "pip install %s" pkg)))))
    (when vue-install
      (let ((default-directory app-dir))
        (message "%s" (shell-command-to-string "npm install"))
        (message "%s" (shell-command-to-string "npm run build"))))
    (when npm-install
      (let ((default-directory app-dir))
        (message "%s" (shell-command-to-string "npm install"))))
    (when npm-rebuild
      (let ((default-directory app-dir))
        (message "%s" (shell-command-to-string "npm rebuild"))))))
#+end_src
安装 eaf 核心
#+begin_src emacs-lisp
(package! eaf
  :recipe (:host github :repo "emacs-eaf/emacs-application-framework"
           :files ("*")
           :post-build
           (shell-command "python install-eaf.py --install-core-deps")))
#+end_src
安装浏览器
#+begin_src emacs-lisp
(package! eaf-browser
  :recipe (:host github :repo "emacs-eaf/eaf-browser"
           :files ("*")
           :post-build
           (+eaf-install-deps-for-app
            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-browser"))))
#+end_src
安装终端
#+begin_src emacs-lisp
(package! eaf-pyqterminal
  :recipe (:host github :repo "mumu-lhl/eaf-pyqterminal"
           :files ("*")
           :post-build
           (+eaf-install-deps-for-app
            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-pyqterminal"))))
#+end_src
安装文件管理器
#+begin_src emacs-lisp
(package! eaf-file-manager
  :recipe (:host github :repo "emacs-eaf/eaf-file-manager"
           :files ("*")
           :post-build
           (+eaf-install-deps-for-app
            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-file-manager"))))
#+end_src
一些有 bug 的包
#+begin_src emacs-lisp
;;(package! eaf-org-previewer
;;  :recipe (:host github :repo "emacs-eaf/eaf-org-previewer"
;;           :files ("*")
;;           :post-build
;;           (+eaf-install-deps-for-app
;;            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-org-previewer"))))
;;(package! eaf-markdown-previewer
;;  :recipe (:host github :repo "emacs-eaf/eaf-markdown-previewer"
;;           :files ("*")
;;           :post-build
;;           (+eaf-install-deps-for-app
;;            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-markdown-previewer"))))
;;(package! eaf-pdf-viewer
;;  :recipe (:host github :repo "emacs-eaf/eaf-pdf-viewer"
;;           :files ("*")
;;           :post-build
;;           (+eaf-install-deps-for-app
;;            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-pdf-viewer"))))
;;(package! eaf-git
;;  :recipe (:host github :repo "emacs-eaf/eaf-git"
;;           :files ("*")
;;           :post-build
;;           (+eaf-install-deps-for-app
;;            (concat straight-base-dir "/straight/" straight-build-dir "/eaf-git"))))
#+end_src
*** holo-layer
懒猫开发的各种特效，没有准 =Linux= 环境所以目前唯一成功的环境是 =wslg+sway= 。

这个模块会破坏 =blink-search= 的窗口，不建议启用。
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/holo-layer/config.el
:END:
#+begin_src emacs-lisp
;;; modules/baosize/holo-layer/config.el -*- lexical-binding: t; -*-
#+end_src
解决找不到函数的 bug
#+begin_src emacs-lisp
(add-to-list 'load-path "~/.emacs.d/.local/straight/repos/blink-search/backend/")
#+end_src
启动 =holo-layer=
#+begin_src emacs-lisp
(use-package holo-layer
  :custom
  (holo-layer-enable-cursor-animation t)
  (holo-layer-enable-type-animation t)
  (holo-layer-enable-indent-rainbow t)
  (holo-layer-cursor-color t)
  (holo-layer-cursor-alpha 255)
  (holo-layer-type-animation-style 'supernova)
  (holo-layer-sort-tab-ui)
  :config
  (holo-layer-enable))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/holo-layer/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/holo-layer/packages.el
(package! holo-layer
  :recipe (:host github :repo "manateelazycat/holo-layer"
           :files ("*")))
#+end_src
*** sort-tab
懒猫的标签栏，启用 =holo-layer= 即可显示图标
**** config.el
#+begin_src emacs-lisp :tangle modules/baosize/sort-tab/config.el
;;; modules/baosize/sort-tab/config.el -*- lexical-binding: t; -*-
(use-package sort-tab
  :defer t
  :hook
  (doom-after-init . sort-tab-mode)
  :init
  (bind-keys ("C-c b]" . sort-tab-select-next-tab)
        ("C-c bn" . sort-tab-select-next-tab)
        ("C-c b[" . sort-tab-select-prev-tab)
        ("C-c bp" . sort-tab-select-prev-tab)
        ("C-c bl" . sort-tab-select-last-tab)
        ("C-c bK" . sort-tab-close-all-tabs)
        ("C-c bO" . sort-tab-close-other-tabs)
        ("C-c bd" . sort-tab-close-current-tab)
        ("C-c bk" . sort-tab-close-current-tab)))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/sort-tab/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/sort-tab/packages.el
(package! sort-tab
  :recipe (:host github :repo "manateelazycat/sort-tab"))
#+end_src
*** chinese
设置 emacs-rime 输入法， Rime 在 =~/.local/share/emacs-rime= 文件夹中设置。 
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/chinese/config.el
:END:
#+begin_src emacs-lisp
;;; modules/baosize/chinese/config.el -*- lexical-binding: t; -*-
#+end_src
使用 =ace-pinyin= 以支持 =avy= 跳转到中文

使用 =pinyin-lib= 以支持 =consult= 搜索中文
#+begin_src emacs-lisp
(use-package ace-pinyin
  :after avy
  :init (setq ace-pinyin-use-avy t)
  :config (ace-pinyin-global-mode t))
(use-package pinyinlib
  :commands (pinyinlib-build-regexp-string)
  :init
  (defun orderless-regexp-pinyin (str)
    (setf (car str) (pinyinlib-build-regexp-string (car str)))
    str)
  (advice-add 'orderless-regexp :filter-args #'orderless-regexp-pinyin))
#+end_src
禁用系统输入法
=Fcitx5= 什么的在 =Emacs= 上的体验很不好。
#+begin_src emacs-lisp
; disable gtk im modules for emacs-pgtk, add "Emacs*UseXIM: false" to ~/.Xresources to disable xim
(when (boundp 'pgtk-use-im-context-on-new-connection)
  (setq pgtk-use-im-context-on-new-connection nil))
#+end_src
=use-package= 声明
#+begin_src emacs-lisp
(use-package rime
#+end_src
键绑定
#+begin_src emacs-lisp 
  :bind
  (:map rime-mode-map ("C-`" . #'rime-send-keybinding))
#+end_src
自动切换输入法
#+begin_src emacs-lisp
  :custom
  (rime-disable-predicates
      '(rime-predicate-evil-mode-p
           meow-normal-mode-p
           meow-keypad-mode-p
           meow-motion-mode-p
           rime-predicate-hydra-p
           rime-predicate-prog-in-code-p
           rime-predicate-space-after-cc-p
           ;; rime-predicate-org-in-src-block-p
           rime-predicate-org-latex-mode-p
           rime-predicate-punctuation-after-space-cc-p
           rime-predicate-punctuation-after-ascii-p
           rime-predicate-punctuation-line-begin-p
           ;; rime-predicate-space-after-ascii-p
           ;; rime-predicate-space-after-cc-p
           rime-predicate-after-ascii-char-p))
#+end_src
Rime 本身相关设置
#+begin_src emacs-lisp
  ;; (rime-share-data-dir
  ;;  (cl-some (lambda (dir)
  ;;             (let ((abs-dir (expand-file-name dir)))
  ;;               (when (file-directory-p abs-dir)
  ;;                 abs-dir)))
  ;;           '("/usr/share/rime-data"
  ;;             "/usr/share/local"
  ;;             "/usr/share")))
  (rime-user-data-dir (expand-file-name "~/.local/share/emacs-rime"))
  (rime-show-candidate 'posframe)
  (rime-posframe-style 'vertical)
#+end_src
设置默认输入法
#+begin_src emacs-lisp
(default-input-method "rime")
#+end_src
=Org-mode= 自启动
#+begin_src emacs-lisp
 :config
 (add-hook 'org-mode-hook (lambda () (activate-input-method default-input-method)))
#+end_src
防止堵塞、冻结 =Emacs=
#+begin_src emacs-lisp
(add-hook 'kill-emacs-hook (lambda () (ignore-errors (rime-lib-finalize)))))
#+end_src
**** packages.el
#+begin_src emacs-lisp :tangle modules/baosize/chinese/packages.el 
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/chinese/packages.el


(package! rime)
(package! ace-pinyin)
(package! pinyinlib)
(when (modulep! :editor evil) (package! evil-pinyin))
#+end_src
*** lsp
*** corfu
Doom 默认的 corfu 模块很慢，而且和各种配置都不大兼容，所以自己手搓一份得了。
**** autoload.el
自动加载一些定义的 API
#+begin_src emacs-lisp :tangle modules/baosize/mycorfu/autoload.el 
;;; modules/baosize/mycorfu/autoload.el -*- lexical-binding: t; -*-
;;;###if (modulep! +minibuffer)

;;;###autoload
(defun +corfu--enable-in-minibuffer ()
  (unless (or (bound-and-true-p mct--active)
              (bound-and-true-p vertico--input)
              (memq this-command '(evil-ex
                                   evil-ex-search-forward
                                   evil-ex-search-backward))
              (and (modulep! :completion helm)
                   (helm--alive-p))
              (corfu-mode +1))))
#+end_src
**** config.el
:PROPERTIES:
:header-args: :tangle modules/baosize/mycorfu/config.el
:END:
#+begin_src emacs-lisp
;;; modules/baosize/mycorfu/config.el -*- lexical-binding: t; -*-
#+end_src
懒加载 corfu
#+begin_src emacs-lisp
(use-package corfu
  :defer t
  :hook
  (doom-first-buffer . global-corfu-mode)
#+end_src
启用 minibuffer 补全，在最小化配置删掉 =vertico= 时很有用
#+begin_src emacs-lisp
  :config
  (when (featurep! +minibuffer)
    (add-hook 'minibuffer-setup-hook #'+corfu--enable-in-minibuffer))
#+end_src
自动弹出补全
#+begin_src emacs-lisp
  :custom
  (corfu-separator ?\s)
  (corfu-auto t)
  (corfu-auto-delay 0.0)
#+end_src
增加补全文档弹出延时以提高响应速度
#+begin_src emacs-lisp
  (corfu-popupinfo-delay '(0.1 . 0.1))
#+end_src
不要求精确匹配，启用循环匹配
#+begin_src emacs-lisp
  (corfu-on-exact-match nil)
  (corfu-quit-no-match t)
  (corfu-cycle t)
#+end_src
敲两个字符或者按下 TAB 键时弹出补全
#+begin_src emacs-lisp
  (corfu-auto-prefix 2)
  (tab-always-indent 'complete)
#+end_src
弹出补全时绑定基本快捷键
#+begin_src emacs-lisp
  :bind
  (:map corfu-map
   ("C-SPC"    . #'corfu-insert-separator)
   ("C-n"      . #'corfu-next)
   ("C-p"      . #'corfu-previous)
   ("M-p"      . #'corfu-popupinfo-scroll-up)
   ("M-n"      . #'corfu-popupinfo-scroll-down)
   ("M-d"      . #'corfu-popupinfo-toggle)
   ("C-x C-k"  . #'cape-dict)
   ("C-x C-f"  . #'cape-file)))
#+end_src
启用 orderless 方式补全
#+begin_src emacs-lisp
(use-package orderless
 :when (modulep! +orderless)
 :init
 (setq completion-styles '(orderless partial-completion)
       completion-category-defaults nil
       completion-category-overrides '((file (styles . (partial-completion))))))
#+end_src
给 corfu 增加图标（延时加载）
#+begin_src emacs-lisp
(use-package nerd-icons-corfu
  :when (modulep! +icons)
  :defer t
  :init
  (with-eval-after-load 'corfu
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter)))
#+end_src
给 corfu 拓展各种源（延时加载）
#+begin_src emacs-lisp
(use-package cape
  :defer t
  :init
  (bind-keys ([remap dabbrev-expand] . cape-dabbrev))
  (add-hook 'latex-mode-hook (lambda ()(defun +corfu--latex-set-capfs ()
                                (add-to-list 'completion-at-point-functions #'cape-tex))))
  (when (modulep! :checkers spell)
    (add-to-list 'completion-at-point-functions #'cape-dict)
    (add-to-list 'completion-at-point-functions #'cape-ispell))
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-keyword t)
  (add-to-list 'completion-at-point-functions #'cape-dabbrev t))
#+end_src
corfu 基于历史记录的排序方式，在 corfu 之后加载
#+begin_src emacs-lisp
(use-package corfu-history
  :after corfu
  :hook (corfu-mode . (lambda ()
                        (corfu-history-mode 1)
                        (savehist-mode 1)
                        (add-to-list 'savehist-additional-variables 'corfu-history))))
#+end_src
**** packages.el
安装对应插件
#+begin_src emacs-lisp :tangle modules/baosize/mycorfu/packages.el
;; -*- no-byte-compile: t; -*-
;;; modules/baosize/mycorfu/packages.el
(package! corfu
  :recipe (:files (:defaults "extensions/*.el")))
(when (modulep! +icons)
(package! nerd-icons-corfu))
(package! cape)
#+end_src
*** tools
*** treesit-context
:PROPERTIES:
:header-args: :tangle modules/baosize/treesit-context/autoload.el
:END:
类似于 [[https://github.com/nvim-treesitter/nvim-treesitter-context][Nvim Treesitter Context]] 的显示代码层级的插件，代码高度借鉴[[https://emacs-china.org/t/treesit-context-tree-sitter-topsy/25162][Emacs China]]

试着整理一下，当学习 =Emacs Lisp= 了。

定义基本变量，以及文件头
#+begin_src emacs-lisp
;;; modules/baosize/treesit-context/autoload.el -*- lexical-binding: t; -*-
;;;###autoload
(defgroup treesit-context nil
  "Show the context of the currently visible buffer contents."
  :group 'treesit)
(defvar treesit-context--buffer (generate-new-buffer "*treesit-context-posframe-buffer*")
  "Buffer used to display the context.")
(defvar treesit-context--list nil
  "List used to store the context needs showing.")
(defvar treesit-context--timer nil
  "Timer for updating the context.")
#+end_src
声明显示函数（ =Emacs Lisp= 加载的时候会先读取所有源码，然后在源码中查找定义，也就是说无需计较声明顺序，不像某些 C 语言）
#+begin_src emacs-lisp
;;;###autoload
(defun treesit-context ()
  "Show code context."
  (interactive)
  (unless (not (treesit-available-p))
    (local-unset-key (kbd "C-g"))
    (local-set-key (kbd "C-g") 'treesit-context-abort)
    ;; (add-hook 'post-command-hook #'treesit-context--update nil 'local)
    (setq treesit-context--timer (run-with-idle-timer 0.1 t 'treesit-context--update))
    (treesit-context--update)))
#+end_src
声明删除窗口的函数（不知道该怎么称呼这东西了）
#+begin_src emacs-lisp
;;;###autoload
(defun treesit-context-abort ()
  "Abort showing code context."
  (interactive)
  (posframe-hide treesit-context--buffer)
  (local-set-key (kbd "C-g") 'keyboard-quit)
  ;; (kill-buffer treesit-context--buffer)
  ;; (remove-hook 'post-command-hook #'treesit-context--update 'local)
  (when treesit-context--timer
    (cancel-timer treesit-context--timer)))
#+end_src
我们可以显示像 loop,fucntion,condition,class 之类的各种 =tree-sitter node= ，这个时候我们就要维护一个变量记录我们要显示什么东西了。
#+begin_src emacs-lisp
;;;###autoload
(defun treesit-context--add-to-list (node)
  "Add the text of the node into `treesit-context--list'."
  (if (or (string= (treesit-node-type node) "struct_specifier")
	      (string= (treesit-node-type node) "function_definition"))
      (progn
	(let* ((text (treesit-node-text node))
	       (buf (generate-new-buffer "*treesit-context-temp-buffer*"))
	       (text-showed nil))
	  (with-current-buffer buf
	    (goto-char (point-min))	    (insert text)
	    (goto-char (point-min))
	    (setq text-showed (buffer-substring
			       (point-min) (line-end-position))))
	  (push text-showed treesit-context--list)
	  (kill-buffer buf)))))
#+end_src
我们需要从 =tree-sitter= 中查询上下文以显示代码层级。
#+begin_src emacs-lisp
;;;###autoload
(defun treesit-context--get-context-from-list ()
  "Get the context of `treesit-context--list'"
  (let ((context ""))
    (dolist (text treesit-context--list)
      (setq context (concat context text "\n")))
    context))
#+end_src
光标是会动的，层级是会变化的，窗口是要更新的。
#+begin_src emacs-lisp
;;;###autoload
(defun treesit-context--update ()
  "Update `treesit-context--ov'."
  (unless (or (minibufferp) (not (buffer-live-p treesit-context--buffer)))
    (setq treesit-context--list nil)
    (ignore-errors
      (let* ((node (treesit-node-at (point))))
	(cl-loop while node
		 do (treesit-context--add-to-list node)
		 do (setq node (treesit-node-parent node)))))
    (if treesit-context--list
	(progn
	  (with-current-buffer treesit-context--buffer
	    (erase-buffer)
	    (insert (treesit-context--get-context-from-list)))
	  (when (posframe-workable-p)
	    (posframe-show treesit-context--buffer
			   :poshandler #'posframe-poshandler-window-top-right-corner
			   :background-color "#454545"
			   :border-width 5
			   :border-color "#454545")))
      (posframe-hide treesit-context--buffer))))
#+end_src
*** vterm-run
**** autoload.el
:PROPERTIES:
:header-args: :tangle modules/baosize/vterm-run/autoload.el
:END:
判断是否开启了 =vterm= 模块
#+begin_src emacs-lisp
;;; modules/baosize/vterm-run/autoload.el -*- lexical-binding: t; -*-
;;;###if (modulep! :term vterm)
#+end_src
将内容发送给 =vterm=
#+begin_src emacs-lisp
;;;###autoload
(defun run-in-vterm (command)
  "Execute string COMMAND in a new vterm.
   Interactively, prompt for COMMAND with the current buffer's file
   name supplied. When called from Dired, supply the name of the
   file at point.
   Like `async-shell-command`, but run in a vterm for full terminal features.
   The new vterm buffer is named in the form `*foo bar.baz*`, the
   command and its arguments in earmuffs.
   When the command terminates, the shell remains open, but when the
   shell exits, the buffer is killed."
  (interactive
   (list
    (let* ((f (cond (buffer-file-name)
                    ((eq major-mode 'dired-mode)
                     (dired-get-filename nil t))))
           (filename (if f
                         (concat " " (shell-quote-argument f))
                       "")))
      (read-shell-command "Terminal command: "
                          (cons filename 0)
                          (cons 'shell-command-history 1)
                          (list filename)))))
  (+vterm/toggle nil)
  (vterm-send-string command)
  (vterm-send-return))
#+end_src
运行代码
#+begin_src emacs-lisp
;;;###autoload
(defun run-code ()
  (interactive)
  (if buffer-file-name
    (let ((file-name (shell-quote-argument
                      (file-name-sans-extension
                       (file-name-nondirectory buffer-file-name))))
          (file-path (shell-quote-argument buffer-file-name))
          (dir (shell-quote-argument
                (if (doom-project-root) (doom-project-root)
                  (file-name-directory buffer-file-name)))))
      (pcase major-mode
        ('c-ts-mode (run-in-vterm (concat "cd " dir " && "
                                        "gcc -O2 -std=c11 -g3 "
                                        file-path
                                        " -o /tmp/c-" file-name
                                        " && /tmp/c-" file-name)))
        ('c++-ts-mode (run-in-vterm (concat "cd " dir " && "
                                          "g++ -O2 -std=gnu++17 -g3 "
                                          file-path
                                          " -o /tmp/cpp-" file-name
                                          " && /tmp/cpp-" file-name)))
        ('python-ts-mode (run-in-vterm (concat "cd " dir " && "
                                             "python " file-path)))
        (_ (message "not supported"))))
  (message "buffer-file-name is nil")))
#+end_src
进行代码错误检查
#+begin_src emacs-lisp
;;;###autoload
(defun run-cpp-fsanitize ()
  (interactive)
  (if buffer-file-name
      (let ((filename (file-name-sans-extension (file-name-nondirectory buffer-file-name)))
            (dir (if (doom-project-root) (doom-project-root) (file-name-directory buffer-file-name))))
        (run-in-vterm (concat "cd " dir " && " "clang++ -O2 -std=c++17 -fsanitize=undefined " buffer-file-name " -o /tmp/cpp-" filename " && /tmp/cpp-" filename)))
    (message "buffer-file-name is nil")))
#+end_src
**** config.el
绑定一些快捷键
#+begin_src emacs-lisp :tangle modules/baosize/vterm-run/config.el
;;; modules/baosize/vterm-run/config.el -*- lexical-binding: t; -*-
(when (modulep! :term vterm)
  (bind-keys ("C-c o TAB" . run-in-vterm)
        ("C-c oo" . run-code)
        ("C-c ot" . +vterm/toggle)
        ("C-c oF" . run-cpp-fsanitize)))
#+end_src
